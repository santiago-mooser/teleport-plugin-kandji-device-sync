name: Docker SLSA3 Build & Publish

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build and publish both container variants
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image.outputs.image }}
      standard-digest: ${{ steps.build-standard.outputs.digest }}
      prod-digest: ${{ steps.build-prod.outputs.digest }}
      version: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build and push standard Alpine-based container
        uses: docker/build-push-action@v5
        id: build-standard
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.title=${{ github.repository }}
            org.opencontainers.image.description=Teleport Plugin for Kandji Device Sync
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          build-args: |
            GIT_COMMIT_TAG=${{ steps.meta.outputs.version }}
            GIT_COMMIT_SHA=${{ github.sha }}
            GIT_COMMIT_MESSAGE=${{ github.event.head_commit.message }}
            IMAGE_BUILD_TIME=${{ github.event.repository.updated_at }}
            CI_PROJECT_URL=${{ github.server_url }}/${{ github.repository }}
            CI_PROJECT_NAME=${{ github.repository }}

      - name: Build and push production Distroless-based container
        uses: docker/build-push-action@v5
        id: build-prod
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-prod:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-prod:latest
          labels: |
            org.opencontainers.image.title=${{ github.repository }}-prod
            org.opencontainers.image.description=Teleport Plugin for Kandji Device Sync (Production/Distroless)
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          build-args: |
            GIT_COMMIT_TAG=${{ steps.meta.outputs.version }}
            GIT_COMMIT_SHA=${{ github.sha }}
            GIT_COMMIT_MESSAGE=${{ github.event.head_commit.message }}
            IMAGE_BUILD_TIME=${{ github.event.repository.updated_at }}
            CI_PROJECT_URL=${{ github.server_url }}/${{ github.repository }}
            CI_PROJECT_NAME=${{ github.repository }}

      - name: Output image name
        id: image
        run: |
          # Normalize image name to lowercase for SLSA provenance
          image_name=$(echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          echo "image=${image_name}" >> "$GITHUB_OUTPUT"

  # Generate SLSA3 provenance for standard container
  provenance-standard:
    needs: [build]
    permissions:
      actions: read # for detecting the Github Actions environment
      id-token: write # for creating OIDC tokens for signing
      packages: write # for uploading attestations
    if: startsWith(github.ref, 'refs/tags/')
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.build.outputs.image }}
      digest: ${{ needs.build.outputs.standard-digest }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # Generate SLSA3 provenance for production container
  provenance-production:
    needs: [build]
    permissions:
      actions: read # for detecting the Github Actions environment
      id-token: write # for creating OIDC tokens for signing
      packages: write # for uploading attestations
    if: startsWith(github.ref, 'refs/tags/')
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.build.outputs.image }}-prod
      digest: ${{ needs.build.outputs.prod-digest }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # Summary job to output build information
  summary:
    runs-on: ubuntu-latest
    needs: [build, provenance-standard, provenance-production]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Output build summary
        run: |
          echo "ğŸ³ Successfully built and published container images with SLSA3 provenance:"
          echo ""
          echo "ğŸ“¦ Standard (Alpine-based):"
          echo "   â€¢ ${{ needs.build.outputs.image }}:${{ needs.build.outputs.version }}"
          echo "   â€¢ ${{ needs.build.outputs.image }}:latest"
          echo "   â€¢ SHA: ${{ needs.build.outputs.standard-digest }}"
          echo ""
          echo "ğŸ“¦ Production (Distroless-based):"
          echo "   â€¢ ${{ needs.build.outputs.image }}-prod:${{ needs.build.outputs.version }}"
          echo "   â€¢ ${{ needs.build.outputs.image }}-prod:latest"
          echo "   â€¢ SHA: ${{ needs.build.outputs.prod-digest }}"
          echo ""
          echo "ğŸ” SLSA3 provenance attestations generated and published"
          echo "ğŸ“‹ Usage examples:"
          echo "   docker pull ${{ needs.build.outputs.image }}:${{ needs.build.outputs.version }}"
          echo "   docker pull ${{ needs.build.outputs.image }}-prod:${{ needs.build.outputs.version }}"
          echo ""
          echo "ğŸ” Verify provenance with slsa-verifier:"
          echo "   slsa-verifier verify-image ${{ needs.build.outputs.image }}:${{ needs.build.outputs.version }} \\"
          echo "     --source-uri github.com/${{ github.repository }}"
